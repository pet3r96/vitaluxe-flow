name: Deploy Supabase Functions

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/functions/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          supabase link --project-ref $SUPABASE_PROJECT_REF

      - name: Deploy all functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "Deploying all edge functions..."
          
          # Deploy all functions in the functions directory
          for function_dir in supabase/functions/*/; do
            if [ -d "$function_dir" ]; then
              function_name=$(basename "$function_dir")
              
              # Skip _shared directory
              if [ "$function_name" = "_shared" ]; then
                continue
              fi
              
              echo "Deploying function: $function_name"
              supabase functions deploy "$function_name" --no-verify-jwt || {
                echo "Failed to deploy $function_name"
                exit 1
              }
            fi
          done
          
          echo "All functions deployed successfully!"

      - name: Verify critical functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          echo "Verifying critical video functions..."
          
          CRITICAL_FUNCTIONS=(
            "generate-agora-token"
            "join-video-session"
            "test-agora-token"
            "validate-video-guest-link"
            "agora-echo"
          )
          
          for func in "${CRITICAL_FUNCTIONS[@]}"; do
            echo "Checking $func..."
            supabase functions list | grep -q "$func" || {
              echo "Critical function $func not found!"
              exit 1
            }
          done
          
          echo "All critical functions verified!"

      - name: Test public endpoints
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          echo "Testing public endpoints..."
          
          # Test agora-echo (public endpoint)
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://$SUPABASE_PROJECT_REF.supabase.co/functions/v1/agora-echo")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úì agora-echo endpoint is reachable"
          else
            echo "‚úó agora-echo endpoint returned: $RESPONSE"
            exit 1
          fi
          
          # Test edge-ping (public endpoint)
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://$SUPABASE_PROJECT_REF.supabase.co/functions/v1/edge-ping")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úì edge-ping endpoint is reachable"
          else
            echo "‚úó edge-ping endpoint returned: $RESPONSE"
            exit 1
          fi

      - name: Deployment summary
        if: success()
        run: |
          echo "üéâ Deployment completed successfully!"
          echo ""
          echo "Deployed functions are available at:"
          echo "https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co/functions/v1/"
          echo ""
          echo "To view logs: supabase functions logs <function-name>"
          echo "To test locally: supabase functions serve"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo ""
          echo "To troubleshoot:"
          echo "1. Check function logs: supabase functions logs <function-name>"
          echo "2. Verify secrets are configured in GitHub"
          echo "3. Test deployment locally: supabase functions deploy <function-name>"
          echo "4. Check for TypeScript errors in function code"
